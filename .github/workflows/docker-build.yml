name: Docker Multi-Platform Build

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      custom_tag:
        description: 'Custom tag for the image (optional)'
        required: false
        type: string
      push_to_dockerhub:
        description: 'Push to DockerHub'
        required: false
        type: boolean
        default: false

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€åˆ†æ”¯/PR åªè¿è¡Œæœ€æ–°çš„å·¥ä½œæµ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/etftool

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ç”¨äºåˆ›å»º Release
      packages: write  # ç”¨äºæ¨é€é•œåƒ

    steps:
      # ============================================
      # æ­¥éª¤ 1: Checkout ä»£ç 
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ============================================
      # æ­¥éª¤ 2: æå–ç‰ˆæœ¬å·
      # ============================================
      - name: Extract version from git
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # æ ‡ç­¾å‘å¸ƒ: ä½¿ç”¨æ ‡ç­¾ç‰ˆæœ¬ï¼ˆç§»é™¤ 'v' å‰ç¼€ï¼‰
            VERSION=${GITHUB_REF#refs/tags/v}
          elif [[ "${{ github.ref }}" == refs/heads/main ]]; then
            # Main åˆ†æ”¯: ä½¿ç”¨ main-{hash}
            VERSION="main-$(git rev-parse --short HEAD)"
          else
            # å…¶ä»–åˆ†æ”¯: ä½¿ç”¨ {branch}-{hash}
            VERSION="${GITHUB_REF_NAME}-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      # ============================================
      # æ­¥éª¤ 3: è®¾ç½® QEMUï¼ˆå¤šå¹³å°æ”¯æŒï¼‰
      # ============================================
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      # ============================================
      # æ­¥éª¤ 3: è®¾ç½® Docker Buildx
      # ============================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      # ============================================
      # æ­¥éª¤ 4: ç™»å½• DockerHub
      # ============================================
      - name: Login to DockerHub
        # ä»…åœ¨é PR æˆ–æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©æ¨é€æ—¶ç™»å½•
        if: github.event_name != 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.push_to_dockerhub == 'true')
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ============================================
      # æ­¥éª¤ 5: æå– Docker å…ƒæ•°æ®ï¼ˆæ ‡ç­¾å’Œæ³¨é‡Šï¼‰
      # ============================================
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_IMAGE }}
          tags: |
            # åˆ†æ”¯åç§°ï¼ˆä¾‹å¦‚ï¼šmainï¼‰
            type=ref,event=branch
            # PR ç¼–å·ï¼ˆä¾‹å¦‚ï¼špr-123ï¼‰
            type=ref,event=pr
            # è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ï¼šv1.2.3ï¼‰
            type=semver,pattern={{version}}
            # ä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ï¼šv1.2ï¼‰
            type=semver,pattern={{major}}.{{minor}}
            # ä¸»ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ï¼šv1ï¼‰
            type=semver,pattern={{major}}
            # ä¸º main åˆ†æ”¯æ·»åŠ  latest æ ‡ç­¾
            type=raw,value=latest,enable={{is_default_branch}}
            # ä¸ºç‰ˆæœ¬æ ‡ç­¾æ·»åŠ  latest æ ‡ç­¾
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            # è‡ªå®šä¹‰æ ‡ç­¾ï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ï¼‰
            type=raw,value=${{ github.event.inputs.custom_tag }},enable=${{ github.event.inputs.custom_tag != '' }}
          labels: |
            org.opencontainers.image.title=ETFTool
            org.opencontainers.image.description=Aè‚¡ ETF åˆ†æå·¥å…· - å‰å¤æƒæ”¶ç›Šåˆ†æä¸“å®¶
            org.opencontainers.image.vendor=ETFTool

      # ============================================
      # æ­¥éª¤ 6: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      # ============================================
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          # ä»…åœ¨é PR æˆ–æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©æ¨é€æ—¶æ¨é€
          push: ${{ github.event_name != 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.push_to_dockerhub == 'true') }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # ä½¿ç”¨ GitHub Actions ç¼“å­˜
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # æ„å»ºå‚æ•°
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            APP_VERSION=${{ steps.version.outputs.version }}

      # ============================================
      # æ­¥éª¤ 7: ç”Ÿæˆæ„å»ºæ‘˜è¦
      # ============================================
      - name: Generate build summary
        if: always()
        run: |
          echo "## ğŸ³ Docker æ„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯/æ ‡ç­¾**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºçŠ¶æ€**: ${{ steps.build.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "### ğŸ“¦ ç”Ÿæˆçš„é•œåƒæ ‡ç­¾" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${{ github.event_name }}" != "pull_request" ] || [ "${{ github.event.inputs.push_to_dockerhub }}" == "true" ]; then
              echo "### âœ… é•œåƒå·²æ¨é€åˆ° DockerHub" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "æ‹‰å–é•œåƒ:" >> $GITHUB_STEP_SUMMARY
              echo '```bash' >> $GITHUB_STEP_SUMMARY
              # æ ¹æ®äº‹ä»¶ç±»å‹ä½¿ç”¨ä¸åŒçš„æ ‡ç­¾
              if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
                echo "docker pull ${{ env.REGISTRY_IMAGE }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
              else
                echo "docker pull ${{ env.REGISTRY_IMAGE }}:${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
              fi
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "### â„¹ï¸ é•œåƒä»…æ„å»ºéªŒè¯ï¼Œæœªæ¨é€" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ æ„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

      # ============================================
      # æ­¥éª¤ 8: éªŒè¯å¤šæ¶æ„æ¸…å•
      # ============================================
      - name: Verify multi-arch manifest
        if: steps.build.outcome == 'success' && (github.event_name != 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.push_to_dockerhub == 'true'))
        run: |
          # æ ¹æ®äº‹ä»¶ç±»å‹ç¡®å®šè¦éªŒè¯çš„æ ‡ç­¾
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # ç‰ˆæœ¬æ ‡ç­¾ï¼šä½¿ç”¨ä¸å¸¦ v å‰ç¼€çš„ç‰ˆæœ¬å·
            VERIFY_TAG="${{ steps.version.outputs.version }}"
          else
            # åˆ†æ”¯æ¨é€ï¼šä½¿ç”¨åˆ†æ”¯å
            VERIFY_TAG="${{ github.ref_name }}"
          fi

          echo "éªŒè¯å¤šæ¶æ„é•œåƒæ¸…å•: $VERIFY_TAG"
          docker buildx imagetools inspect ${{ env.REGISTRY_IMAGE }}:$VERIFY_TAG

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ—ï¸ å¤šæ¶æ„æ”¯æŒ" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker buildx imagetools inspect ${{ env.REGISTRY_IMAGE }}:$VERIFY_TAG >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ============================================
      # æ­¥éª¤ 9: åˆ›å»º GitHub Releaseï¼ˆä»…ç‰ˆæœ¬æ ‡ç­¾ï¼‰
      # ============================================
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v') && steps.build.outcome == 'success'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            ## ğŸš€ ETFTool ${{ github.ref_name }}

            ### Docker é•œåƒ

            å¤šå¹³å°æ”¯æŒï¼ˆlinux/amd64, linux/arm64ï¼‰:

            ```bash
            docker pull ${{ env.REGISTRY_IMAGE }}:${{ steps.version.outputs.version }}
            ```

            ### å¿«é€Ÿå¯åŠ¨

            ```bash
            docker run -d \
              -p 3000:3000 \
              -v etftool-data:/app/backend/data \
              --name etftool \
              ${{ env.REGISTRY_IMAGE }}:${{ steps.version.outputs.version }}
            ```

            è®¿é—®: http://localhost:3000

            ### æ›´æ–°æ—¥å¿—

            è¯·æŸ¥çœ‹æäº¤å†å²ä»¥è·å–è¯¦ç»†æ›´æ”¹ã€‚
          draft: false
          prerelease: false
