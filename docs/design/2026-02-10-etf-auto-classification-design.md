# ETF 自动分类标签功能 - 设计文档

> 创建时间: 2026-02-10
> 状态: 设计阶段
> 优先级: P1（高用户价值，中等开发投入）

---

## 1. 功能定位

### 1.1 为什么需要这个功能？

**核心痛点**：
- **信息过载**：A股市场有数百只 ETF，用户难以快速筛选和发现感兴趣的品种
- **认知成本高**：新手用户不了解 ETF 的行业、主题、风格分类，需要逐个查看
- **搜索效率低**：当前只能通过代码/名称搜索，缺乏分类浏览和筛选能力
- **投资决策难**：无法快速找到同类 ETF 进行对比分析

**用户价值**：
- 降低 ETF 选择门槛，帮助新手快速理解市场结构
- 提升搜索和浏览效率，支持按行业/主题快速筛选
- 辅助投资决策，方便同类 ETF 对比分析
- 增强产品竞争力，提供更专业的分类体系

### 1.2 核心价值主张

**为投资者提供"一目了然"的 ETF 分类导航**

- 自动识别 ETF 的行业、主题、风格属性
- 支持多维度标签筛选和分类浏览
- 智能推荐同类 ETF，方便横向对比
- 自选列表自动分组，清晰管理持仓结构

---

## 2. 需求分析

### 2.1 用户场景

**场景1：探索式浏览**
```
用户："我想看看有哪些科技类 ETF"
期望：点击"科技"标签，展示所有科技相关的 ETF
```

**场景2：主题投资**
```
用户："最近看好新能源，有哪些相关 ETF？"
期望：搜索"新能源"或点击标签，快速找到相关品种
```

**场景3：风格配置**
```
用户："我想配置一些红利类 ETF"
期望：筛选"红利"标签，对比不同红利 ETF 的收益表现
```

**场景4：同类对比**
```
用户：查看"半导体ETF"详情页
期望：自动推荐其他半导体 ETF，方便对比费率、规模、收益
```

### 2.2 功能需求

**核心功能**：
1. **自动分类**：基于 ETF 名称自动识别分类标签
2. **标签展示**：在搜索结果、详情页、自选列表中展示标签
3. **分类筛选**：支持按标签筛选 ETF
4. **分类浏览**：提供分类导航入口，按行业/主题浏览
5. **同类推荐**：在详情页推荐同类 ETF
6. **自选分组**：自选列表按标签自动分组

**非功能需求**：
- 分类准确率 ≥ 85%
- 标签计算性能 < 1ms
- 支持新 ETF 自动分类
- 规则易于维护和调整

---

## 3. 分类体系设计

### 3.1 统一标签列表模型

基于 A股 ETF 市场特点，采用**统一标签列表模型**：

**设计理念**：
- 每个 ETF 拥有一个**有序的扁平标签列表**，标签之间无互斥约束
- 每个标签携带 `group` 元数据，用于前端筛选器分组展示
- 后端数据模型保持扁平，前端按需分组

**选择理由**（对比多维度互斥模型）：
- **消除分类冲突**：如"恒生科技"可同时拥有 [跨境] 和 [科技] 标签，无需纠结 index_type 选谁
- **结构简单**：一个列表即可表达所有分类信息，无需维护多个字段的一致性
- **扩展灵活**：新增标签类型无需修改数据结构

### 3.2 标签数据结构

```json
{
  "tags": [
    {"label": "行业", "group": "type"},
    {"label": "半导体", "group": "industry"}
  ]
}
```

**字段说明**：
- `label`：标签显示文本
- `group`：标签分组，取值为 `"type"` | `"industry"` | `"strategy"` | `"special"`

### 3.3 标签分组定义

#### **group: "type"（大类标签）**

大类标签用于标识 ETF 的基础属性，一个 ETF 可以有多个大类标签：

| 大类标签 | 说明 |
|---------|------|
| **宽基** | 跟踪宽基指数：沪深300、中证500、中证1000、上证50、创业板、科创板等 |
| **行业** | 跟踪行业/主题指数（当有具体行业标签时自动添加） |
| **策略** | 跟踪策略指数：红利、价值、成长、低波动等 |
| **跨境** | 跟踪境外指数：恒生、纳斯达克、标普等 |
| **商品** | 跟踪商品价格：黄金、白银、原油等 |

#### **group: "industry"（行业/主题标签）**

**金融行业**：
- 金融、银行、券商、保险、非银金融

**科技行业**：
- 半导体、芯片、集成电路
- 计算机、软件、互联网
- 通信、5G
- 电子
- 人工智能、AI

**消费行业**：
- 医药、生物、医疗、CXO
- 食品饮料、白酒、啤酒
- 消费、零售、商贸
- 家电、家居
- 汽车、整车、新能源车

**新能源与环保**：
- 新能源、光伏、风电、储能
- 电池、锂电
- 环保、碳中和、绿色

**周期行业**：
- 有色金属、铜、铝、稀土
- 煤炭、化工、石化
- 钢铁、建材、水泥

**其他行业**：
- 军工、国防
- 地产、房地产、REITs
- 基建、建筑
- 农业、种业
- 传媒、文化、游戏
- 电力、公用事业
- 机器人、机床

**主题投资**：
- 科创板、创业板
- 央企、国企、民企
- 一带一路、长三角、京津冀、粤港澳大湾区

**商品细分标签**（group 为 `"industry"`）：
- 黄金、白银、原油、豆粕
- 有商品细分标签时，"商品"大类标签**保留**（类似"宽基"始终保留的逻辑）

#### **group: "strategy"（投资风格标签）**
- 红利、价值、成长、低波动、质量、增强

#### **group: "special"（特殊属性标签）**
- 杠杆、反向、ESG、QDII、LOF、联接

### 3.4 展示规则

**卡片展示**（StockCard 最多显示 2 个标签）：
- 标签按 group 排序：type → industry → strategy → special
- 取排序后的前 2 个标签展示
- 详情页可展示完整标签列表

**去冗余规则**：
- 如果已有具体行业标签（如"半导体"），则不再添加泛化的"行业"大类标签
- 如果已有具体策略标签（如"红利"），则不再添加泛化的"策略"大类标签
- 即：大类标签仅在没有更具体标签时才保留

**示例**：
```
ETF: "半导体ETF"
全部标签: [半导体]              ← "行业"大类被去冗余
卡片展示: [半导体]

ETF: "恒生科技"
全部标签: [跨境, 科技]          ← "行业"大类被去冗余（已有"科技"）
卡片展示: [跨境] [科技]

ETF: "红利低波"
全部标签: [红利, 低波动]        ← "策略"大类被去冗余
卡片展示: [红利] [低波动]

ETF: "沪深300ETF"
全部标签: [宽基, 沪深300]       ← "宽基"保留（沪深300 是指数名非行业）
卡片展示: [宽基] [沪深300]

ETF: "科创50"
全部标签: [宽基, 科技]          ← 科创板产生"科技"标签
卡片展示: [宽基] [科技]

ETF: "科创50增强"
全部标签: [宽基, 科技, 增强]
卡片展示: [宽基] [科技]         ← 取前2个
```

---

## 4. 技术实现方案

### 4.1 方案选择

经过对比分析，选择**基于 ETF 名称的规则匹配方案**：

| 方案 | 优点 | 缺点 | 评分 |
|------|------|------|------|
| **规则匹配（推荐）** | 零外部依赖、准确率85%+、实时生效、易维护 | 需要维护规则库 | ⭐⭐⭐⭐⭐ |
| 爬取第三方数据 | 准确率高 | 需要维护爬虫、可能不稳定 | ⭐⭐⭐ |
| 手工维护配置 | 最准确 | 维护成本高、不适合大量ETF | ⭐⭐ |
| 混合方案 | 平衡准确性和成本 | 复杂度较高 | ⭐⭐⭐⭐ |

**选择理由**：
- A股 ETF 命名规范性强，名称中通常包含行业/主题关键词
- 无需外部依赖，降低系统复杂度和维护成本
- 新 ETF 上市即可自动分类，无需人工干预
- 规则清晰，易于调整和优化

### 4.2 核心分类逻辑

#### 4.2.1 规则匹配引擎

采用**全量扫描、全部保留**策略，不使用优先级覆盖：

```
输入：ETF 名称（如"恒生科技"）
     ↓
【Step 1: 扫描大类关键词 → 添加 group=type 标签】
  命中"黄金/白银/原油"等 → 加 [商品]
  命中"恒生/纳指/标普/中概/A50"等 → 加 [跨境]
  命中"红利/价值/成长/低波/增强"等 → 加 [策略]
  命中"沪深300/中证500/上证50/创业板/科创"等 → 加 [宽基]
  （大类标签不互斥，可同时命中多个）
     ↓
【Step 2: 扫描细分关键词 → 添加 group=industry/strategy 标签】
  命中"半导体/芯片/集成电路" → 加 [半导体] (industry)
  命中"医药/医疗/生物/CXO" → 加 [医药] (industry)
  命中"科技/科创/AI/人工智能" → 加 [科技] (industry)
  命中"红利" → 加 [红利] (strategy)
  命中"低波" → 加 [低波动] (strategy)
  ... 更多关键词
     ↓
【Step 3: 扫描特殊属性 → 添加 group=special 标签】
  命中"QDII/LOF/联接/增强"等 → 加对应标签
     ↓
【Step 4: 去冗余 + 排序】
  - 有具体行业标签时，移除泛化的"行业"大类
  - 有具体策略标签时，移除泛化的"策略"大类
  - 按 group 排序：type → industry → strategy → special
     ↓
输出：有序标签列表
  [{"label": "跨境", "group": "type"},
   {"label": "科技", "group": "industry"}]
```

#### 4.2.2 冲突解决策略

**核心原则**：不使用优先级覆盖，所有匹配到的标签全部保留。

**去冗余规则**：
- 大类标签（type）仅在没有更具体的同类标签时保留
- 例：有 [半导体] 时不加 [行业]，有 [红利] 时不加 [策略]
- 但 [宽基] 和 [跨境] 始终保留（它们本身就是具体信息）

**排除词规则**：
- "非银金融" → 匹配"非银金融"，不应匹配"银行"
- "医药50" → "50"不应触发宽基指数匹配（需精确匹配"上证50""科创50"等完整词）

**科创板特殊处理**：
- "科创50""科创板50""科创ETF" → 加 [宽基] + [科技]
- 科创板本身是科技创新板块，产生"科技"行业标签是合理的

#### 4.2.3 关键词库设计

**宽基指数关键词**（精确匹配，约15个）：
```python
BROAD_BASE_KEYWORDS = {
    "沪深300": "沪深300", "中证500": "中证500", "中证1000": "中证1000",
    "中证2000": "中证2000", "上证50": "上证50", "上证180": "上证180",
    "创业板": "创业板", "创业板50": "创业板",
    "科创50": "科创板", "科创板50": "科创板", "科创板": "科创板",
    "深100": "深证100", "中小100": "中小100",
    # 数字模式扩展
    "300ETF": "沪深300", "500ETF": "中证500",
    "1000ETF": "中证1000", "2000ETF": "中证2000",
}
```

**跨境指数关键词**：
```python
CROSS_BORDER_KEYWORDS = [
    "恒生", "纳指", "纳斯达克", "标普", "中概",
    "港股", "美股", "日经", "德国", "法国",
    # 英文/数字模式扩展
    "A50",  # 富时A50（跨境，非A股宽基）
]
```

**商品关键词**：
```python
COMMODITY_KEYWORDS = ["黄金", "白银", "原油", "豆粕", "有色金属"]
```

**商品细分关键词**（group=industry，与"商品"大类共存）：
```python
COMMODITY_DETAIL_KEYWORDS = {
    "黄金": ["黄金"],
    "白银": ["白银"],
    "原油": ["原油"],
    "豆粕": ["豆粕"],
}
```

**行业分类关键词**（约30个大类，每个支持多个同义词）：
```python
INDUSTRY_KEYWORDS = {
    "半导体": ["半导体", "芯片", "集成电路"],
    "医药": ["医药", "医疗", "生物医药", "创新药", "CXO", "医疗器械"],
    "科技": ["科技", "科创", "信息技术"],
    "人工智能": ["人工智能", "AI", "AIETF", "机器人"],
    "新能源": ["新能源", "光伏", "风电", "储能"],
    "新能源车": ["新能源车", "新能车", "整车"],
    "金融": ["金融"],
    "券商": ["券商", "证券"],
    "银行": ["银行"],
    "保险": ["保险"],
    "非银金融": ["非银"],
    "军工": ["军工", "国防"],
    "食品饮料": ["酒", "白酒", "啤酒", "食品饮料"],
    "消费": ["消费", "零售", "商贸"],
    "家电": ["家电", "家居"],
    "汽车": ["汽车"],
    "电子": ["电子"],
    "计算机": ["计算机", "软件"],
    "通信": ["通信", "5G"],
    "传媒": ["传媒", "文化", "游戏"],
    "有色金属": ["有色", "铜", "铝", "稀土"],
    "煤炭": ["煤炭"],
    "化工": ["化工", "石化"],
    "钢铁": ["钢铁", "建材", "水泥"],
    "房地产": ["房地产", "地产", "REITs"],
    "基建": ["基建", "建筑"],
    "农业": ["农业", "种业", "养殖"],
    "电力": ["电力", "公用事业"],
    "旅游": ["旅游"],
    "互联网": ["互联网", "中概互联"],
    "机床": ["机床"],
    # ... 更多
}
```

**策略关键词**：
```python
STRATEGY_KEYWORDS = ["红利", "价值", "成长", "低波", "质量", "增强"]
```

**排除规则**（安全网机制）：
```python
# 当匹配到 key 时，排除 value 列表中的标签
EXCLUSION_RULES = {
    "非银": ["银行"],      # "非银ETF"不应匹配"银行"
}
```
> 注意：关键词库中禁止添加过短的同义词（如单字"银"），以避免误匹配。

**宽基数字模式匹配规则**：
- 完整词匹配："沪深300"、"中证500"、"上证50"、"科创50" 等
- 数字+ETF 模式："300ETF"、"500ETF"、"1000ETF" 等
- "创业板50"匹配"创业板"（而非"上证50"）
- "医药50"中的"50"不匹配任何宽基（因为前面是"医药"而非宽基关键词）
- 具体实现：宽基数字模式只在**名称以数字开头**或**数字前面是宽基关键词**时才触发

**准确率提升策略**：
1. **长关键词优先匹配**：优先匹配"非银金融"再匹配"金融"，避免"非银ETF"被误标为"银行"
2. **精确匹配宽基指数**：宽基关键词需完整匹配（"上证50"而非"50"），防止"医药50"被误判
3. **英文/数字模式扩展**：关键词库包含 AI、5G、A50 等中英混合模式
4. **排除词处理**：定义排除规则（如匹配"非银"时跳过"银行"检查）

#### 4.2.4 验证矩阵（关键边界用例）

以下用例用于验证分类规则的正确性，阶段0完成后必须全部通过：

| ETF 名称 | 期望标签 | 冲突类型 | 说明 |
|----------|---------|---------|------|
| `沪深300ETF` | `[宽基, 沪深300]` | 无 | 纯宽基 |
| `半导体ETF` | `[半导体]` | 无 | 纯行业，"行业"大类被去冗余 |
| `恒生科技` | `[跨境, 科技]` | 跨境+行业 | 两个标签共存，不互斥 |
| `恒生生物` | `[跨境, 医药]` | 跨境+行业 | 同上 |
| `中概互联` | `[跨境, 互联网]` | 跨境+行业 | 同上 |
| `红利ETF` | `[红利]` | 无 | "策略"大类被去冗余 |
| `红利低波` | `[红利, 低波动]` | 多策略 | 两个策略标签共存 |
| `科创50` | `[宽基, 科技]` | 宽基+行业 | 科创板产生"科技"标签 |
| `科创50增强` | `[宽基, 科技, 增强]` | 宽基+行业+策略 | 多标签叠加 |
| `黄金ETF` | `[商品, 黄金]` | 无 | 纯商品 |
| `AIETF` | `[人工智能]` | 英文名称 | 关键词库扩展覆盖 |
| `1000ETF` | `[宽基, 中证1000]` | 数字名称 | 关键词库扩展覆盖 |
| `A50ETF` | `[跨境, 富时A50]` | 字母+数字 | A50 是跨境（富时A50） |
| `酒ETF` | `[食品饮料]` | 短名称 | "酒"映射到食品饮料 |
| `医药50` | `[医药]` | 数字干扰 | "50"不应触发宽基匹配 |
| `创成长` | `[宽基, 成长]` | 宽基+策略 | 创业板+成长策略 |
| `非银ETF` | `[非银金融]` | 排除词 | 不应匹配"银行" |
| `券商ETF` | `[券商]` | 同义词 | 与"证券ETF"归为同类 |
| `新能源车` | `[新能源车]` | 近义词 | 与"新能车ETF"归为同类 |
| `300ETF华夏` | `[宽基, 沪深300]` | 后缀干扰 | 基金公司名在后缀 |
| `5G通信` | `[通信]` | 数字开头 | 数字开头不应触发宽基 |
| `恒生ETF` | `[跨境]` | 纯跨境 | 纯跨境无行业标签 |
| `创业板50` | `[宽基, 创业板]` | 数字干扰 | "50"不应触发上证50 |
| `标普500` | `[跨境]` | 数字干扰 | "500"不应触发中证500 |
| `军工龙头` | `[军工]` | 无关词 | "龙头"不应成为标签 |
| `生物医药` | `[医药]` | 多同义词 | 多个同义词同时出现只产生一个标签 |
| `新能车ETF` | `[新能源车]` | 缩写 | 缩写匹配 |
| `沪深300LOF` | `[宽基, 沪深300, LOF]` | 宽基+特殊属性 | LOF 属性识别 |
| `沪深300增强` | `[宽基, 沪深300, 增强]` | 宽基+策略 | 增强型宽基 |
| `创业板联接` | `[宽基, 创业板, 联接]` | 宽基+特殊属性 | 联接基金识别 |
| `华夏上证50ETF联接A` | `[宽基, 上证50, 联接]` | 长名称+后缀 | 长名称含基金公司后缀 |

### 4.3 数据存储与缓存

#### 4.3.1 存储方案（推荐：实时计算）

**方案A：实时计算 + 内存缓存（推荐）**
```
优点：
- 无需额外存储空间
- 新 ETF 自动分类
- 规则更新立即生效

实现：
- 在 akshare_service.py 的数据获取流程中调用分类器（数据加载到内存前计算）
- 分类器在 fetch_all_etfs() 的每个成功返回点之前调用 _enrich_with_tags()
- 冷启动恢复路径（get_etf_info 中从 DiskCache 恢复）同样需要调用分类器
- cache.py 保持纯粹的数据存储职责，不包含业务逻辑
- 计算量很小（<1ms/个），500个ETF全量计算 < 500ms

关键设计决策：
- DiskCache 不存储 tags，tags 始终实时计算
- DiskCache 存储原始 ETF 数据（code, name, price, change_pct, volume）
- tags 在数据加载到内存缓存时实时计算
- 规则更新后无需清理 DiskCache 即可生效
- Fallback JSON 同理，加载时动态生成 tags
```

**方案B：预计算存储**
```
优点：
- 查询速度快
- 可手动修正错误分类

缺点：
- 需要维护额外数据
- 新 ETF 需要触发重新分类

实现：
- 定时任务（每日）对所有 ETF 进行分类
- 存储到 JSON 文件或数据库
- 提供管理接口手动修正
```

**推荐方案A**，理由：
- 分类计算非常轻量，无需预计算
- 规则更新立即生效，无需重新计算
- 减少数据一致性问题

#### 4.3.2 缓存策略

```
层级1: 内存缓存（etf_cache）
  - 存储 ETF 基础信息 + 分类标签（tags 在写入内存前实时计算）
  - 生命周期：与 ETF 列表同步刷新（4小时）
  - 位置：app/core/cache.py

层级2: DiskCache
  - 仅存储原始 ETF 数据（不含 tags）
  - 用于冷启动恢复，恢复时重新计算 tags
  - 位置：.cache/
```

### 4.4 核心代码结构

**新增文件**：
```
backend/app/services/etf_classifier.py  # 分类器服务
backend/app/data/classification_rules.json  # 分类规则配置（可选）
```

**修改文件**：
```
backend/app/services/akshare_service.py  # 集成分类器（数据获取后、写入缓存前调用）
backend/app/api/v1/endpoints/etf.py  # 修改API响应，新增标签相关端点
```

> 注意：`cache.py` 保持纯粹的数据存储职责，不需要修改。分类逻辑在 `akshare_service.py` 中完成。

**分类器接口设计**：
```python
class ETFTag:
    label: str   # 标签显示文本
    group: str   # 分组: "type" | "industry" | "strategy" | "special"

class ETFClassifier:
    @classmethod
    def classify(cls, etf_name: str, etf_code: str = "") -> List[ETFTag]:
        """对 ETF 进行分类，返回有序标签列表"""
        pass

    @classmethod
    def get_display_tags(cls, tags: List[ETFTag], limit: int = 2) -> List[str]:
        """获取用于前端展示的标签文本列表（默认最多2个）"""
        pass
```

---

## 5. API 设计

### 5.1 新增 API 端点

#### 5.1.1 获取所有分类标签

```
GET /api/v1/etf/tags

响应：
{
  "groups": {
    "type": ["宽基", "行业", "策略", "跨境", "商品"],
    "industry": ["半导体", "医药", "科技", "人工智能", "新能源", "券商", ...],
    "strategy": ["红利", "价值", "成长", "低波动", "质量", "增强"],
    "special": ["杠杆", "反向", "QDII", "ESG", "LOF", "联接"]
  }
}

用途：前端筛选器的分组选项列表
```

#### 5.1.2 按标签搜索 ETF

```
GET /api/v1/etf/search-by-tags?tags=半导体

查询参数：
- tags: 标签名称（必选，支持多个，逗号分隔，默认 OR 逻辑）
- group: 限定标签分组（可选，如 group=industry）

说明：
- 默认 OR 逻辑更符合用户直觉（"我想看半导体或医药"）
- 同 group 内 OR 逻辑：?tags=半导体,医药 → 返回半导体或医药的 ETF

响应：
{
  "items": [
    {
      "code": "512480",
      "name": "半导体ETF",
      "price": 0.76,
      "change_pct": 2.5,
      "tags": [
        {"label": "半导体", "group": "industry"}
      ]
    },
    ...
  ],
  "total": 15
}
```

#### 5.1.3 获取同类 ETF

```
GET /api/v1/etf/{code}/similar?limit=5

响应：
{
  "items": [
    {
      "code": "159995",
      "name": "芯片ETF",
      "price": 1.23,
      "change_pct": 3.2,
      "similarity_score": 0.95,
      "common_tags": ["半导体"],
      "tags": [
        {"label": "半导体", "group": "industry"}
      ]
    },
    ...
  ]
}

相似度算法：
- 使用加权匹配分数（非标准 Jaccard，因标准 Jaccard 不支持加权）
- 权重定义：WEIGHT = {"industry": 3, "strategy": 2, "type": 1, "special": 1}
- 计算公式：score = weighted_common / weighted_total
  - weighted_common = 两个 ETF 标签**交集**中每个标签权重之和
  - weighted_total = 两个 ETF 标签**并集**中每个标签权重之和
- 排除 type 类标签（如"宽基"、"商品"）参与相似度计算，因为太泛化会导致所有宽基 ETF 互相推荐
- 排除自身
- 按相似度降序排序

计算示例：
  ETF A: [半导体(3), 增强(2)]  → weighted = 5
  ETF B: [半导体(3), 科技(3)]  → weighted = 6
  common（交集）: [半导体(3)]          → weighted_common = 3
  union（并集）:  [半导体(3), 增强(2), 科技(3)] → weighted_total = 8
  score = 3/8 = 0.375
```

### 5.2 修改现有 API

#### 5.2.1 搜索接口增加标签（含标签融合搜索）

```
GET /api/v1/etf/search?q=半导体

搜索逻辑变更：
- 同时做文本搜索（名称/代码匹配）和标签匹配
- 文本搜索：匹配名称含"科技"的 ETF（现有逻辑）
- 标签搜索：匹配标签为"科技"的 ETF（如"科创50"、"AIETF"等）
- 合并去重后返回
- 前端无需修改搜索逻辑
- /search-by-tags 保留给标签筛选器专用

响应增加 tags 字段：
{
  "items": [
    {
      "code": "512480",
      "name": "半导体ETF",
      "price": 0.76,
      "change_pct": 2.5,
      "tags": [
        {"label": "半导体", "group": "industry"}
      ]
    }
  ]
}
```

#### 5.2.2 批量价格接口增加标签

```
GET /api/v1/etf/batch-price?codes=510300,512480

响应增加 tags 字段（同上）

说明：tags 已在内存缓存中（读取成本为零），且数据量极小（每个 ETF 增加约 40-80 字节），
直接返回。前端按需使用即可。
```

#### 5.2.3 ETF 详情接口增加标签

```
GET /api/v1/etf/{code}/info

响应增加 tags 字段（同上）
```

---

## 6. 前端 UI 设计

### 6.1 场景1：搜索页面的分类筛选

**布局设计**：
```
┌─────────────────────────────┐
│  搜索                        │
│  ┌─────────────────────┐    │
│  │🔍 输入代码或名称    │    │
│  └─────────────────────┘    │
│                              │
│  快速筛选：                  │
│  [宽基] [跨境] [策略] [商品] │  ← group=type 标签（横向滚动）
│                              │
│  行业分类：                  │
│  [半导体] [医药] [新能源]... │  ← group=industry 标签（横向滚动）
│                              │
│  搜索结果：                  │
│  ┌─────────────────────┐    │
│  │ 512480 半导体ETF     │    │
│  │💰 0.76  📈 +2.5%    │    │
│  │ [半导体]             │    │  ← 标签展示（最多2个）
│  └─────────────────────┘    │
└─────────────────────────────┘
```

**交互逻辑**：
1. 搜索框为空时显示标签筛选器（探索模式）
2. 搜索框有内容时隐藏标签筛选器（搜索模式）
3. 两种模式互斥，避免用户困惑
4. 标签筛选器采用**级联模式**：先选 type（5个），再显示对应的 industry 标签
5. 标签高亮显示已选中状态
6. 清空按钮快速重置筛选

**实现要点**：
- 前端按 `group` 元数据分组展示标签（后端数据模型保持扁平列表）
- 使用 `/etf/tags` 接口获取各 group 的可选标签列表
- 使用横向滚动容器展示标签（移动端友好）
- 标签按钮最小点击区域 44x44px
- 选中状态使用主题色高亮

### 6.2 场景2：首页的分类浏览入口

**设计方案：横向滚动标签（推荐）**
```
┌─────────────────────────────┐
│  我的自选                    │
│  [自选列表...]               │
│                              │
│  热门分类 >                  │
│  [宽基指数] [半导体] [医药]  │  ← 横向滚动
│  [新能源] [红利] [券商]...   │
│                              │
│  点击查看该分类下的所有 ETF  │
└─────────────────────────────┘
```

**优点**：
- 占用空间小，不影响自选列表
- 横向滚动符合移动端习惯
- 可展示更多分类选项

**实现要点**：
- 热门分类：半导体、医药、新能源、红利、券商、消费等（6-8个）
- 点击标签 → 跳转到搜索页并自动筛选
- 右侧显示"更多"按钮 → 跳转到完整分类页面

### 6.3 场景3：详情页的同类推荐

```
┌─────────────────────────────┐
│  512480 半导体ETF            │
│  [价格图表...]               │
│  [指标卡片...]               │
│                              │
│  同类 ETF 对比               │
│  ┌─────────────────────┐    │
│  │ 159995 芯片ETF       │    │
│  │ 💰 1.23  📈 +3.2%    │    │
│  │ CAGR: 15%  MDD: -25% │    │
│  └─────────────────────┘    │
│  ┌─────────────────────┐    │
│  │ 512760 半导体50      │    │
│  │ 💰 0.89  📉 -1.5%    │    │
│  │ CAGR: 12%  MDD: -30% │    │
│  └─────────────────────┘    │
│                              │
│  [查看更多同类 ETF >]        │
└─────────────────────────────┘
```

**推荐算法**：
1. 计算标签相似度（categories 权重最高）
2. 优先推荐同行业、不同基金公司的 ETF
3. 按市值/成交量排序
4. 最多展示 5 个

**实现要点**：
- 使用 StockCard 组件展示（复用现有组件）
- 显示核心指标：价格、涨跌幅、CAGR、MDD
- 点击卡片 → 跳转到对应 ETF 详情页
- 支持横向滑动查看更多

### 6.4 场景4：自选列表的分组管理（长期探索，暂不实现）

> **状态**：从当前路线图移除，推迟到用户反馈确认需求后再考虑。
>
> **推迟理由**：
> - 首页已有拖拽排序、下拉刷新等复杂交互，分组功能会与拖拽排序冲突
> - 大多数用户自选列表只有 10-20 只 ETF，分组必要性不大
> - 如果要做，只做"视图切换"（全部/按分类），分组视图下禁用拖拽排序

```
┌─────────────────────────────┐
│  我的自选                    │
│                              │
│  分组查看：                  │
│  [全部(12)] [宽基(3)] [科技(5)] [医药(2)] [其他(2)]
│                              │
│  当前分组：科技               │
│  ┌─────────────────────┐    │
│  │ 512480 半导体ETF     │    │
│  │ [行业主题] [半导体]  │    │
│  └─────────────────────┘    │
│  ┌─────────────────────┐    │
│  │ 159995 芯片ETF       │    │
│  │ [行业主题] [半导体]  │    │
│  └─────────────────────┘    │
│  ...                         │
└─────────────────────────────┘
```

**实现逻辑**：
1. 自动根据标签分组（无需用户手动分类）
2. 支持多标签 ETF 出现在多个分组
3. 分组标签显示 ETF 数量
4. 点击分组切换视图
5. "其他"分组：无明确分类或小众分类的 ETF

**实现要点**：
- 使用横向滚动标签展示分组
- 默认显示"全部"分组
- 分组数量动态计算
- 保持拖拽排序功能（在分组内排序）

---

## 7. 实施路线图

### 7.0 阶段0：分类器独立验证

**目标**：在不修改任何现有代码的情况下验证分类规则的质量

**任务清单**：
- [ ] 后端：创建分类器服务 `app/services/etf_classifier.py`
- [ ] 后端：实现规则匹配引擎和完整关键词库
- [ ] 测试：编写参数化单元测试，覆盖验证矩阵全部用例
- [ ] 验证：用全量 ETF 列表跑分类，输出结果
- [ ] 验证：人工审核分类结果，调整规则
- [ ] 验证：统计准确率，确认 ≥ 85%
- [ ] 测试：边界测试（空名称、特殊字符、超长名称）
- [ ] 测试：性能测试（全量 ETF 分类 < 500ms）

**验收标准**：
- 验证矩阵全部用例通过
- 全量 ETF 分类准确率 ≥ 85%
- 全量分类性能 < 500ms

### 7.1 阶段1：核心分类功能（MVP）

**目标**：将分类器集成到系统中，实现基础分类能力

**任务清单**：
- [ ] 后端：集成分类器到 `akshare_service.py`，在获取 ETF 信息时自动分类
- [ ] 后端：修改 `/etf/search` 接口，响应中增加 `tags` 字段，融合标签搜索
- [ ] 后端：修改 `/etf/batch-price` 接口，响应中增加 `tags` 字段
- [ ] 前端：在搜索结果的 StockCard 中展示标签
- [ ] 测试：端到端验证分类标签正确展示
- [ ] 文档：更新 API 文档和 AGENTS.md

**预计工作量**：1-2天

**验收标准**：
- 分类准确率 ≥ 85%
- 标签计算性能 < 1ms
- 前端正确展示标签

### 7.2 阶段2：搜索筛选功能

**目标**：支持按标签筛选

**任务清单**：
- [ ] 后端：实现 `/etf/tags` 接口，返回所有可用标签
- [ ] 后端：实现 `/etf/search-by-tags` 接口，支持按标签筛选
- [ ] 前端：搜索页面添加标签筛选器组件
- [ ] 前端：实现标签选择交互（多选、清空、高亮）
- [ ] 前端：集成筛选 API，展示筛选结果
- [ ] 测试：筛选功能端到端测试
- [ ] 文档：更新用户使用文档

**预计工作量**：2天

**验收标准**：
- 支持多标签筛选（默认 OR 逻辑）
- 筛选结果准确
- 移动端交互流畅

### 7.3 阶段3：分类浏览与同类推荐

**目标**：完善用户体验

**任务清单**：
- [ ] 后端：实现 `/etf/{code}/similar` 接口，返回同类 ETF（加权匹配分数算法）
- [ ] 前端：首页添加"热门分类"横向滚动标签
- [ ] 前端：详情页添加"同类 ETF 对比"模块
- [ ] 前端：优化标签展示样式（颜色、图标）
- [ ] 测试：端到端测试所有场景
- [ ] 文档：更新功能说明文档

**预计工作量**：2-3天

**验收标准**：
- 同类推荐准确度 ≥ 80%
- 所有场景交互流畅

### 7.4 阶段4：优化与迭代

**目标**：提升准确率和用户体验

**任务清单**：
- [ ] 收集用户反馈，统计分类错误案例
- [ ] 调整分类规则，提升准确率
- [ ] 添加手动修正机制（管理员功能，可选）
- [ ] 性能优化（缓存策略、查询优化）
- [ ] 添加单元测试和集成测试
- [ ] 文档：更新 AGENTS.md 和 docs/README.md

**预计工作量**：1-2天

**验收标准**：
- 分类准确率 ≥ 90%
- 性能无明显下降
- 测试覆盖率 ≥ 80%

---

## 8. 风险与挑战

### 8.1 准确率问题

**风险描述**：
规则匹配可能出现误分类，已识别的边界情况包括：
- 跨境+行业交叉：如"恒生科技"需同时产生跨境和科技标签
- 宽基+行业交叉：如"科创50"需同时产生宽基和科技标签
- 英文/数字名称：如"AIETF""1000ETF""A50ETF"需要扩展关键词覆盖
- 排除词冲突：如"非银ETF"不应匹配"银行"
- 短名称映射：如"酒ETF"需映射到"食品饮料"

**解决方案**：
1. **统一标签列表模型**：不使用优先级覆盖，所有匹配标签全部保留，从根本上消除互斥冲突
2. **去冗余规则**：有具体行业/策略标签时自动移除泛化的大类标签
3. **长关键词优先匹配**：避免子串误匹配（如"非银金融"优先于"金融"）
4. **精确匹配宽基指数**：防止"医药50"中的"50"触发宽基匹配
5. **扩展关键词库**：覆盖英文、数字、中英混合等特殊命名模式

**验证措施**：
- 4.2.4 节定义了 31 个关键边界用例的验证矩阵，阶段0完成后必须全部通过
- 阶段0完成后用全量 ETF 列表验证整体准确率 ≥ 85%
- 根据测试结果调整规则，收集用户反馈持续优化

### 8.2 维护成本

**风险描述**：
新主题 ETF 出现时需要更新规则，例如：
- 2024年出现"量子计算ETF"，规则库中没有相关关键词
- 行业分类标准变化（如申万行业分类调整）

**解决方案**：
1. **规则配置化**：将关键词库存储在 JSON 文件中，无需改代码
2. **定期审查**：每月审查新上市 ETF 的分类结果
3. **管理后台**：提供管理接口快速添加新规则（可选）
4. **社区反馈**：鼓励用户反馈分类错误

**缓解措施**：
- 建立规则更新流程文档
- 设置定期审查提醒（每月1次）
- 优先覆盖主流行业和主题（覆盖80%的ETF即可）
- 关键词库纳入 Git 版本管理，每次规则变更时运行分类器对全量 ETF 重新分类，diff 输出变化
- 可选：添加管理员端点 `/admin/etf/reclassify` 手动触发重新分类

### 8.3 未匹配 ETF 的处理

**处理策略**：
- 未匹配到任何标签的 ETF 返回空标签列表 `[]`
- 在日志中记录未匹配的 ETF 名称，便于后续补充规则
- 前端对空标签列表做兼容处理（不显示标签区域）

### 8.4 性能影响

**风险描述**：
每次请求都计算分类可能影响性能，特别是：
- 批量获取价格时（50个ETF）
- 搜索结果较多时（100+个ETF）

**解决方案**：
1. **轻量级计算**：分类计算仅为字符串匹配，性能 < 1ms
2. **内存缓存**：分类结果随 ETF 信息一起缓存
3. **懒加载**：前端分页加载，避免一次性渲染大量标签
4. **性能监控**：添加性能监控，及时发现瓶颈

**缓解措施**：
- 阶段1完成后进行性能测试
- 如有性能问题，可改为预计算方案
- 优化关键词匹配算法（使用字典树等数据结构）

---

## 9. 总结与建议

### 9.1 核心优势

✅ **零外部依赖**：不需要爬虫或第三方 API，降低系统复杂度
✅ **高准确率**：基于 A股 ETF 命名规范，预计准确率 85-90%
✅ **易于维护**：规则清晰，配置化管理，易于调整和优化
✅ **实时生效**：新 ETF 自动分类，规则更新立即生效
✅ **性能优异**：轻量级计算（<1ms），对系统性能影响可忽略
✅ **用户价值高**：降低选择门槛，提升搜索效率，辅助投资决策

### 9.2 最佳实践建议

1. **MVP 优先**：先实现核心分类功能，验证准确率和用户反馈
2. **渐进式推出**：按阶段逐步添加 UI 功能，避免一次性开发过多
3. **用户反馈驱动**：根据实际使用情况调整规则和优先级
4. **保持简单**：避免过度设计，标签不宜过多（3-4个为宜）
5. **持续优化**：定期审查分类结果，收集错误案例，优化规则

### 9.3 关键成功因素

- **准确率**：分类准确率是核心指标，需要持续监控和优化
- **性能**：确保分类计算不影响系统响应速度
- **易用性**：标签展示清晰，筛选交互流畅
- **可维护性**：规则易于理解和修改，降低维护成本

### 9.4 后续扩展方向

**短期（3个月内）**：
- 完成 MVP 和基础功能
- 收集用户反馈，优化分类规则
- 提升准确率到 90%+

**中期（6个月内）**：
- 添加更多分类维度（如市值规模、流动性等级）
- 支持自定义标签（用户可为 ETF 添加个人标签）
- 提供分类统计和分析功能

**长期（1年内）**：
- 基于标签的智能推荐系统
- 标签组合策略回测
- 行业轮动分析工具

---

## 10. 附录

### 10.1 参考资料

- [申万行业分类标准](https://www.swsresearch.com/)
- [中证指数公司行业分类](https://www.csindex.com.cn/)
- [东方财富 ETF 分类](https://fund.eastmoney.com/etf/)

### 10.2 相关文档

- [AGENTS.md](../../AGENTS.md) - 项目开发规范
- [PRD.md](../planning/PRD.md) - 产品需求文档
- [FEATURE-ROADMAP.md](../planning/FEATURE-ROADMAP.md) - 功能路线图

### 10.3 更新日志

| 日期 | 版本 | 说明 |
|------|------|------|
| 2026-02-10 | v1.0 | 初始版本，完成设计方案 |
| 2026-02-10 | v1.1 | 分类模型改为统一标签列表；新增冲突解决策略和验证矩阵；扩展关键词库覆盖英文/数字名称；更新 API 响应格式；集成点改为缓存写入时计算 |
| 2026-02-10 | v1.2 | 深度评审优化：集成点从 cache.py 改为 akshare_service.py；DiskCache 不存储 tags 始终实时计算；搜索逻辑改为默认 OR；/search 融合标签搜索；相似度算法改为加权匹配分数；补充商品细分标签、金融、保险关键词；新增排除规则机制和宽基数字模式匹配规则；验证矩阵扩展至 27 个用例；新增阶段0独立验证；自选分组降级为长期探索 |
| 2026-02-10 | v1.3 | 设计修正：明确相似度算法 weighted_total 为标签并集加权总和并补充计算示例；修正"互联网"关键词从 ["互联"] 改为 ["互联网", "中概互联"] 避免误匹配；验证矩阵新增 4 个边界用例（LOF、增强、联接）扩展至 31 个；同步更新 PRD 第 3.7 节（OR 逻辑、2 个标签、统一 ?tags= 参数） |

---

**最后更新**: 2026-02-10

