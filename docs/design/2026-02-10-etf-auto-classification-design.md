# ETF 自动分类标签功能 - 设计文档

> 创建时间: 2026-02-10
> 状态: 设计阶段
> 优先级: P1（高用户价值，中等开发投入）

---

## 1. 功能定位

### 1.1 为什么需要这个功能？

**核心痛点**：
- **信息过载**：A股市场有数百只 ETF，用户难以快速筛选和发现感兴趣的品种
- **认知成本高**：新手用户不了解 ETF 的行业、主题、风格分类，需要逐个查看
- **搜索效率低**：当前只能通过代码/名称搜索，缺乏分类浏览和筛选能力
- **投资决策难**：无法快速找到同类 ETF 进行对比分析

**用户价值**：
- 降低 ETF 选择门槛，帮助新手快速理解市场结构
- 提升搜索和浏览效率，支持按行业/主题快速筛选
- 辅助投资决策，方便同类 ETF 对比分析
- 增强产品竞争力，提供更专业的分类体系

### 1.2 核心价值主张

**为投资者提供"一目了然"的 ETF 分类导航**

- 自动识别 ETF 的行业、主题、风格属性
- 支持多维度标签筛选和分类浏览
- 智能推荐同类 ETF，方便横向对比
- 自选列表自动分组，清晰管理持仓结构

---

## 2. 需求分析

### 2.1 用户场景

**场景1：探索式浏览**
```
用户："我想看看有哪些科技类 ETF"
期望：点击"科技"标签，展示所有科技相关的 ETF
```

**场景2：主题投资**
```
用户："最近看好新能源，有哪些相关 ETF？"
期望：搜索"新能源"或点击标签，快速找到相关品种
```

**场景3：风格配置**
```
用户："我想配置一些红利类 ETF"
期望：筛选"红利"标签，对比不同红利 ETF 的收益表现
```

**场景4：同类对比**
```
用户：查看"半导体ETF"详情页
期望：自动推荐其他半导体 ETF，方便对比费率、规模、收益
```

### 2.2 功能需求

**核心功能**：
1. **自动分类**：基于 ETF 名称自动识别分类标签
2. **标签展示**：在搜索结果、详情页、自选列表中展示标签
3. **分类筛选**：支持按标签筛选 ETF
4. **分类浏览**：提供分类导航入口，按行业/主题浏览
5. **同类推荐**：在详情页推荐同类 ETF
6. **自选分组**：自选列表按标签自动分组

**非功能需求**：
- 分类准确率 ≥ 85%
- 标签计算性能 < 1ms
- 支持新 ETF 自动分类
- 规则易于维护和调整

---

## 3. 分类体系设计

### 3.1 多维度标签系统

基于 A股 ETF 市场特点，采用**多维度标签系统**，每个 ETF 可以有多个标签：

#### **维度1：指数类型**（基础分类，必选）
- **宽基指数**：沪深300、中证500、中证1000、上证50、创业板指、科创50等
- **行业主题**：医药、科技、消费、金融、军工、新能源等
- **策略指数**：红利、价值、成长、低波、质量、动量、ESG等
- **跨境指数**：恒生科技、纳斯达克100、标普500、港股通等
- **商品指数**：黄金、白银、原油、豆粕、有色金属等

#### **维度2：行业/主题分类**（可多选）

**金融行业**：
- 金融、银行、券商、保险、非银金融

**科技行业**：
- 半导体、芯片、集成电路
- 计算机、软件、互联网
- 通信、5G
- 电子
- 人工智能、AI

**消费行业**：
- 医药、生物、医疗、CXO
- 食品饮料、白酒、啤酒
- 消费、零售、商贸
- 家电、家居
- 汽车、整车、新能源车

**新能源与环保**：
- 新能源、光伏、风电、储能
- 电池、锂电
- 环保、碳中和、绿色

**周期行业**：
- 有色金属、铜、铝、稀土
- 煤炭、化工、石化
- 钢铁、建材、水泥

**其他行业**：
- 军工、国防
- 地产、房地产、REITs
- 基建、建筑
- 农业、种业
- 传媒、文化、游戏
- 电力、公用事业

**主题投资**：
- 科创板、创业板
- 央企、国企、民企
- 一带一路、长三角、京津冀、粤港澳大湾区

#### **维度3：投资风格**（可选）
- 红利、价值、成长、低波动、质量

#### **维度4：特殊属性**（可选）
- 杠杆、反向、ESG、QDII、LOF、联接

### 3.2 标签优先级

**展示优先级**（前端最多显示3-4个标签）：
1. 指数类型（必显示）
2. 行业/主题分类（最多显示2个）
3. 投资风格（如有）
4. 特殊属性（最多显示1个）

**示例**：
```
ETF: "华夏中证500医药卫生ETF"
标签: [行业主题] [医药] [中证500]

ETF: "红利ETF"
标签: [策略指数] [红利]

ETF: "半导体ETF"
标签: [行业主题] [半导体]
```

---

## 4. 技术实现方案

### 4.1 方案选择

经过对比分析，选择**基于 ETF 名称的规则匹配方案**：

| 方案 | 优点 | 缺点 | 评分 |
|------|------|------|------|
| **规则匹配（推荐）** | 零外部依赖、准确率85%+、实时生效、易维护 | 需要维护规则库 | ⭐⭐⭐⭐⭐ |
| 爬取第三方数据 | 准确率高 | 需要维护爬虫、可能不稳定 | ⭐⭐⭐ |
| 手工维护配置 | 最准确 | 维护成本高、不适合大量ETF | ⭐⭐ |
| 混合方案 | 平衡准确性和成本 | 复杂度较高 | ⭐⭐⭐⭐ |

**选择理由**：
- A股 ETF 命名规范性强，名称中通常包含行业/主题关键词
- 无需外部依赖，降低系统复杂度和维护成本
- 新 ETF 上市即可自动分类，无需人工干预
- 规则清晰，易于调整和优化

### 4.2 核心分类逻辑

#### 4.2.1 规则匹配引擎

```
输入：ETF 名称（如"华夏沪深300ETF"）
     ↓
【规则匹配引擎】
  1. 判断指数类型（按优先级）
  2. 提取行业/主题分类（可多个）
  3. 判断投资风格
  4. 提取特殊属性
     ↓
输出：多维度标签
  - 指数类型: "宽基指数"
  - 行业分类: []
  - 投资风格: ""
  - 特殊属性: []
```

#### 4.2.2 规则优先级策略

```
优先级（从高到低）：
1. 商品类（黄金、原油）→ 最高优先级
2. 跨境类（恒生、纳斯达克）→ 次高优先级
3. 策略类（红利、价值）→ 中等优先级
4. 宽基类（沪深300、中证500）→ 较低优先级
5. 行业主题类 → 默认分类
```

**示例**：
```
"黄金ETF" → 商品指数（优先级最高）
"恒生科技ETF" → 跨境指数 + 科技
"红利低波ETF" → 策略指数 + 红利 + 低波动
"沪深300医药ETF" → 行业主题 + 医药（行业优先于宽基）
```

#### 4.2.3 关键词库设计

**宽基指数关键词**（约15个）：
```python
{
    "沪深300": "宽基指数",
    "中证500": "宽基指数",
    "中证1000": "宽基指数",
    "上证50": "宽基指数",
    "创业板": "宽基指数",
    "科创50": "宽基指数",
    # ... 更多
}
```

**行业分类关键词**（约30个大类）：
```python
{
    "半导体": ["半导体", "芯片", "集成电路"],
    "医药": ["医药", "生物", "医疗", "CXO"],
    "新能源": ["新能源", "光伏", "风电", "储能"],
    # ... 更多
}
```

**准确率提升策略**：
1. **多关键词匹配**：每个分类支持多个关键词（如"半导体"、"芯片"、"集成电路"）
2. **组合词优先**：优先匹配长关键词（如"半导体芯片" > "半导体"）
3. **排除词处理**：处理特殊情况（如"非银金融"不应匹配"银行"）

### 4.3 数据存储与缓存

#### 4.3.1 存储方案（推荐：实时计算）

**方案A：实时计算 + 内存缓存（推荐）**
```
优点：
- 无需额外存储空间
- 新 ETF 自动分类
- 规则更新立即生效

实现：
- 在 AkShareService.get_etf_info() 中调用分类器
- 分类结果随 ETF 信息一起缓存到内存
- 计算量很小（<1ms），对性能影响可忽略
```

**方案B：预计算存储**
```
优点：
- 查询速度快
- 可手动修正错误分类

缺点：
- 需要维护额外数据
- 新 ETF 需要触发重新分类

实现：
- 定时任务（每日）对所有 ETF 进行分类
- 存储到 JSON 文件或数据库
- 提供管理接口手动修正
```

**推荐方案A**，理由：
- 分类计算非常轻量，无需预计算
- 规则更新立即生效，无需重新计算
- 减少数据一致性问题

#### 4.3.2 缓存策略

```
层级1: 内存缓存（etf_cache）
  - 存储 ETF 基础信息 + 分类标签
  - 生命周期：与 ETF 列表同步刷新（4小时）
  - 位置：app/core/cache.py

层级2: DiskCache（可选）
  - 存储分类规则的计算结果
  - 用于冷启动加速
  - 位置：.cache/etf_tags/
```

### 4.4 核心代码结构

**新增文件**：
```
backend/app/services/etf_classifier.py  # 分类器服务
backend/app/data/classification_rules.json  # 分类规则配置（可选）
```

**修改文件**：
```
backend/app/services/akshare_service.py  # 集成分类器
backend/app/api/v1/endpoints/etf.py  # 修改API响应
backend/app/core/cache.py  # 缓存标签数据
```

**分类器接口设计**：
```python
class ETFClassifier:
    @classmethod
    def classify(cls, etf_name: str, etf_code: str = "") -> ETFTags:
        """对 ETF 进行分类，返回标签对象"""
        pass

    @classmethod
    def get_display_tags(cls, tags: ETFTags) -> List[str]:
        """获取用于前端展示的标签列表（最多3-4个）"""
        pass
```

---

## 5. API 设计

### 5.1 新增 API 端点

#### 5.1.1 获取所有分类标签

```
GET /api/v1/etf/tags

响应：
{
  "index_types": ["宽基指数", "行业主题", "策略指数", "跨境指数", "商品指数"],
  "categories": ["半导体", "医药", "新能源", "金融", "消费", ...],
  "styles": ["红利", "价值", "成长", "低波动", "质量"],
  "special": ["杠杆", "反向", "QDII", "ESG", "LOF"]
}

用途：前端筛选器的选项列表
```

#### 5.1.2 按标签搜索 ETF

```
GET /api/v1/etf/search-by-tags?index_type=行业主题&category=半导体

查询参数：
- index_type: 指数类型（可选）
- category: 行业/主题分类（可选，支持多个，逗号分隔）
- style: 投资风格（可选）
- special: 特殊属性（可选）

响应：
{
  "items": [
    {
      "code": "512480",
      "name": "半导体ETF",
      "price": 0.76,
      "change_pct": 2.5,
      "tags": {
        "index_type": "行业主题",
        "categories": ["半导体"],
        "style": "",
        "special": [],
        "display_tags": ["行业主题", "半导体"]
      }
    },
    ...
  ],
  "total": 15
}
```

#### 5.1.3 获取同类 ETF

```
GET /api/v1/etf/{code}/similar?limit=5

响应：
{
  "items": [
    {
      "code": "159995",
      "name": "芯片ETF",
      "price": 1.23,
      "change_pct": 3.2,
      "similarity_score": 0.95,
      "common_tags": ["行业主题", "半导体"],
      "tags": {
        "index_type": "行业主题",
        "categories": ["半导体", "芯片"],
        "display_tags": ["行业主题", "半导体", "芯片"]
      }
    },
    ...
  ]
}

相似度算法：
- categories 匹配：权重 0.6
- index_type 匹配：权重 0.3
- style 匹配：权重 0.1
- 排除自身
- 按相似度降序排序
```

### 5.2 修改现有 API

#### 5.2.1 搜索接口增加标签

```
GET /api/v1/etf/search?q=半导体

响应增加 tags 字段：
{
  "items": [
    {
      "code": "512480",
      "name": "半导体ETF",
      "price": 0.76,
      "change_pct": 2.5,
      "tags": {
        "index_type": "行业主题",
        "categories": ["半导体"],
        "style": "",
        "special": [],
        "display_tags": ["行业主题", "半导体"]
      }
    }
  ]
}
```

#### 5.2.2 批量价格接口增加标签

```
GET /api/v1/etf/batch-price?codes=510300,512480

响应增加 tags 字段（同上）
```

#### 5.2.3 ETF 详情接口增加标签

```
GET /api/v1/etf/{code}/info

响应增加 tags 字段（同上）
```

---

## 6. 前端 UI 设计

### 6.1 场景1：搜索页面的分类筛选

**布局设计**：
```
┌─────────────────────────────┐
│  搜索                        │
│  ┌─────────────────────┐    │
│  │🔍 输入代码或名称    │    │
│  └─────────────────────┘    │
│                              │
│  快速筛选：                  │
│  [宽基] [行业] [策略] [跨境] │  ← 指数类型标签（横向滚动）
│                              │
│  行业分类：                  │
│  [半导体] [医药] [新能源]... │  ← 行业标签（横向滚动）
│                              │
│  搜索结果：                  │
│  ┌─────────────────────┐    │
│  │ 512480 半导体ETF     │    │
│  │💰 0.76  📈 +2.5%    │    │
│  │ [行业主题] [半导体]  │    │  ← 标签展示
│  └─────────────────────┘    │
└─────────────────────────────┘
```

**交互逻辑**：
1. 点击标签 → 筛选结果
2. 多选标签 → AND 逻辑（同时满足）
3. 标签高亮显示已选中状态
4. 清空按钮快速重置筛选

**实现要点**：
- 使用横向滚动容器展示标签（移动端友好）
- 标签按钮最小点击区域 44x44px
- 选中状态使用主题色高亮
- 支持键盘导航（桌面端）

### 6.2 场景2：首页的分类浏览入口

**设计方案：横向滚动标签（推荐）**
```
┌─────────────────────────────┐
│  我的自选                    │
│  [自选列表...]               │
│                              │
│  热门分类 >                  │
│  [宽基指数] [半导体] [医药]  │  ← 横向滚动
│  [新能源] [红利] [券商]...   │
│                              │
│  点击查看该分类下的所有 ETF  │
└─────────────────────────────┘
```

**优点**：
- 占用空间小，不影响自选列表
- 横向滚动符合移动端习惯
- 可展示更多分类选项

**实现要点**：
- 热门分类：半导体、医药、新能源、红利、券商、消费等（6-8个）
- 点击标签 → 跳转到搜索页并自动筛选
- 右侧显示"更多"按钮 → 跳转到完整分类页面

### 6.3 场景3：详情页的同类推荐

```
┌─────────────────────────────┐
│  512480 半导体ETF            │
│  [价格图表...]               │
│  [指标卡片...]               │
│                              │
│  同类 ETF 对比               │
│  ┌─────────────────────┐    │
│  │ 159995 芯片ETF       │    │
│  │ 💰 1.23  📈 +3.2%    │    │
│  │ CAGR: 15%  MDD: -25% │    │
│  └─────────────────────┘    │
│  ┌─────────────────────┐    │
│  │ 512760 半导体50      │    │
│  │ 💰 0.89  📉 -1.5%    │    │
│  │ CAGR: 12%  MDD: -30% │    │
│  └─────────────────────┘    │
│                              │
│  [查看更多同类 ETF >]        │
└─────────────────────────────┘
```

**推荐算法**：
1. 计算标签相似度（categories 权重最高）
2. 优先推荐同行业、不同基金公司的 ETF
3. 按市值/成交量排序
4. 最多展示 5 个

**实现要点**：
- 使用 StockCard 组件展示（复用现有组件）
- 显示核心指标：价格、涨跌幅、CAGR、MDD
- 点击卡片 → 跳转到对应 ETF 详情页
- 支持横向滑动查看更多

### 6.4 场景4：自选列表的分组管理

```
┌─────────────────────────────┐
│  我的自选                    │
│                              │
│  分组查看：                  │
│  [全部(12)] [宽基(3)] [科技(5)] [医药(2)] [其他(2)]
│                              │
│  当前分组：科技               │
│  ┌─────────────────────┐    │
│  │ 512480 半导体ETF     │    │
│  │ [行业主题] [半导体]  │    │
│  └─────────────────────┘    │
│  ┌─────────────────────┐    │
│  │ 159995 芯片ETF       │    │
│  │ [行业主题] [半导体]  │    │
│  └─────────────────────┘    │
│  ...                         │
└─────────────────────────────┘
```

**实现逻辑**：
1. 自动根据标签分组（无需用户手动分类）
2. 支持多标签 ETF 出现在多个分组
3. 分组标签显示 ETF 数量
4. 点击分组切换视图
5. "其他"分组：无明确分类或小众分类的 ETF

**实现要点**：
- 使用横向滚动标签展示分组
- 默认显示"全部"分组
- 分组数量动态计算
- 保持拖拽排序功能（在分组内排序）

---

## 7. 实施路线图

### 7.1 阶段1：核心分类功能（MVP）

**目标**：实现基础分类能力

**任务清单**：
- [ ] 后端：创建分类器服务 `app/services/etf_classifier.py`
- [ ] 后端：实现规则匹配引擎和关键词库
- [ ] 后端：集成到 `akshare_service.py`，在获取 ETF 信息时自动分类
- [ ] 后端：修改 `/etf/search` 接口，响应中增加 `tags` 字段
- [ ] 后端：修改 `/etf/batch-price` 接口，响应中增加 `tags` 字段
- [ ] 前端：在搜索结果的 StockCard 中展示标签
- [ ] 测试：抽样100个 ETF，验证分类准确率 ≥ 85%
- [ ] 文档：更新 API 文档和 AGENTS.md

**预计工作量**：2-3天

**验收标准**：
- 分类准确率 ≥ 85%
- 标签计算性能 < 1ms
- 前端正确展示标签

### 7.2 阶段2：搜索筛选功能

**目标**：支持按标签筛选

**任务清单**：
- [ ] 后端：实现 `/etf/tags` 接口，返回所有可用标签
- [ ] 后端：实现 `/etf/search-by-tags` 接口，支持按标签筛选
- [ ] 前端：搜索页面添加标签筛选器组件
- [ ] 前端：实现标签选择交互（多选、清空、高亮）
- [ ] 前端：集成筛选 API，展示筛选结果
- [ ] 测试：筛选功能端到端测试
- [ ] 文档：更新用户使用文档

**预计工作量**：2天

**验收标准**：
- 支持多标签筛选（AND 逻辑）
- 筛选结果准确
- 移动端交互流畅

### 7.3 阶段3：分类浏览与同类推荐

**目标**：完善用户体验

**任务清单**：
- [ ] 后端：实现 `/etf/{code}/similar` 接口，返回同类 ETF
- [ ] 前端：首页添加"热门分类"横向滚动标签
- [ ] 前端：详情页添加"同类 ETF 对比"模块
- [ ] 前端：自选列表添加分组管理功能
- [ ] 前端：优化标签展示样式（颜色、图标）
- [ ] 测试：端到端测试所有场景
- [ ] 文档：更新功能说明文档

**预计工作量**：3-4天

**验收标准**：
- 同类推荐准确度 ≥ 80%
- 分组功能正常工作
- 所有场景交互流畅

### 7.4 阶段4：优化与迭代

**目标**：提升准确率和用户体验

**任务清单**：
- [ ] 收集用户反馈，统计分类错误案例
- [ ] 调整分类规则，提升准确率
- [ ] 添加手动修正机制（管理员功能，可选）
- [ ] 性能优化（缓存策略、查询优化）
- [ ] 添加单元测试和集成测试
- [ ] 文档：更新 AGENTS.md 和 docs/README.md

**预计工作量**：1-2天

**验收标准**：
- 分类准确率 ≥ 90%
- 性能无明显下降
- 测试覆盖率 ≥ 80%

---

## 8. 风险与挑战

### 8.1 准确率问题

**风险描述**：
规则匹配可能出现误分类，例如：
- "华夏中证500医药卫生ETF" 可能被误判为宽基指数
- "科创板50ETF" 可能同时匹配到"科创"和"创业板"

**解决方案**：
1. **细化规则优先级**：行业关键词优先于宽基关键词
2. **添加组合词匹配**："中证500医药" → 行业主题（而非宽基）
3. **排除词处理**：处理特殊情况（如"非银金融"不应匹配"银行"）
4. **提供手动修正机制**：管理员可手动修正错误分类（可选）

**缓解措施**：
- 阶段1完成后进行准确率测试，抽样100个ETF验证
- 根据测试结果调整规则
- 收集用户反馈，持续优化

### 8.2 维护成本

**风险描述**：
新主题 ETF 出现时需要更新规则，例如：
- 2024年出现"量子计算ETF"，规则库中没有相关关键词
- 行业分类标准变化（如申万行业分类调整）

**解决方案**：
1. **规则配置化**：将关键词库存储在 JSON 文件中，无需改代码
2. **定期审查**：每月审查新上市 ETF 的分类结果
3. **管理后台**：提供管理接口快速添加新规则（可选）
4. **社区反馈**：鼓励用户反馈分类错误

**缓解措施**：
- 建立规则更新流程文档
- 设置定期审查提醒（每月1次）
- 优先覆盖主流行业和主题（覆盖80%的ETF即可）

### 8.3 性能影响

**风险描述**：
每次请求都计算分类可能影响性能，特别是：
- 批量获取价格时（50个ETF）
- 搜索结果较多时（100+个ETF）

**解决方案**：
1. **轻量级计算**：分类计算仅为字符串匹配，性能 < 1ms
2. **内存缓存**：分类结果随 ETF 信息一起缓存
3. **懒加载**：前端分页加载，避免一次性渲染大量标签
4. **性能监控**：添加性能监控，及时发现瓶颈

**缓解措施**：
- 阶段1完成后进行性能测试
- 如有性能问题，可改为预计算方案
- 优化关键词匹配算法（使用字典树等数据结构）

---

## 9. 总结与建议

### 9.1 核心优势

✅ **零外部依赖**：不需要爬虫或第三方 API，降低系统复杂度
✅ **高准确率**：基于 A股 ETF 命名规范，预计准确率 85-90%
✅ **易于维护**：规则清晰，配置化管理，易于调整和优化
✅ **实时生效**：新 ETF 自动分类，规则更新立即生效
✅ **性能优异**：轻量级计算（<1ms），对系统性能影响可忽略
✅ **用户价值高**：降低选择门槛，提升搜索效率，辅助投资决策

### 9.2 最佳实践建议

1. **MVP 优先**：先实现核心分类功能，验证准确率和用户反馈
2. **渐进式推出**：按阶段逐步添加 UI 功能，避免一次性开发过多
3. **用户反馈驱动**：根据实际使用情况调整规则和优先级
4. **保持简单**：避免过度设计，标签不宜过多（3-4个为宜）
5. **持续优化**：定期审查分类结果，收集错误案例，优化规则

### 9.3 关键成功因素

- **准确率**：分类准确率是核心指标，需要持续监控和优化
- **性能**：确保分类计算不影响系统响应速度
- **易用性**：标签展示清晰，筛选交互流畅
- **可维护性**：规则易于理解和修改，降低维护成本

### 9.4 后续扩展方向

**短期（3个月内）**：
- 完成 MVP 和基础功能
- 收集用户反馈，优化分类规则
- 提升准确率到 90%+

**中期（6个月内）**：
- 添加更多分类维度（如市值规模、流动性等级）
- 支持自定义标签（用户可为 ETF 添加个人标签）
- 提供分类统计和分析功能

**长期（1年内）**：
- 基于标签的智能推荐系统
- 标签组合策略回测
- 行业轮动分析工具

---

## 10. 附录

### 10.1 参考资料

- [申万行业分类标准](https://www.swsresearch.com/)
- [中证指数公司行业分类](https://www.csindex.com.cn/)
- [东方财富 ETF 分类](https://fund.eastmoney.com/etf/)

### 10.2 相关文档

- [AGENTS.md](../../AGENTS.md) - 项目开发规范
- [PRD.md](../planning/PRD.md) - 产品需求文档
- [FEATURE-ROADMAP.md](../planning/FEATURE-ROADMAP.md) - 功能路线图

### 10.3 更新日志

| 日期 | 版本 | 说明 |
|------|------|------|
| 2026-02-10 | v1.0 | 初始版本，完成设计方案 |

---

**最后更新**: 2026-02-10

