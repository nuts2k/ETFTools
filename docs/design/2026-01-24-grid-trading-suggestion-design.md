# ETFTool 网格交易建议设计文档 (Grid Trading Suggestion Design)

## 1. 概述 (Overview)
本功能旨在帮助 A 股 ETF 投资者根据历史价格波动的科学分析，自动生成“保守型”网格交易参数建议。通过在图表上可视化震荡区间，降低用户设置网格交易的门槛。

## 2. 核心架构 (Architecture)
*   **后端 (FastAPI)**: 新增 `GridService` 负责量化分析，通过现有缓存获取历史 QFQ 数据。
*   **API**: `GET /api/v1/etf/{code}/grid-suggestion`。
*   **前端 (Next.js)**: `ETFChart` 叠加可视化层，新增 `GridSuggestionCard` 展示参数。

## 3. 详细设计 (Detailed Design)

### 3.1 后端算法 (Grid Algorithm)
*   **震荡区检测**: 
    *   使用 30/60 天滑动窗口。
    *   利用 ADX (< 20) 识别趋势缺失，利用变异系数 (CV) 锁定波动平稳区间。
    *   边界选取：震荡区间内收盘价的 5% 和 95% 分位数。
*   **参数计算**:
    *   **间距 (Spacing)**: 动态计算，取 `max(1.5%, 1.2 * ATR / Price)`，采用百分比等比间距。
    *   **格数**: 限制在 5 - 20 格之间。
    *   **破位校验**: 现价偏离区间超过 5% 时标记为 `out_of_range`。

### 3.2 前端交互 (UI/UX)
*   **可视化叠加**: 
    *   在图表上使用淡蓝色 (`#3b82f6`, 10% alpha) 的 `ReferenceArea` 标注识别出的震荡段。
    *   使用 `ReferenceLine` 标注建议的上限与下限价格。
*   **建议卡片**: 
    *   展示上限、下限、间距、格数。
    *   **状态指示**: 正常状态显示蓝色背景；破位状态显示黄色警示，提醒策略失效风险。
    *   **交互**: 提供“复制参数”按钮。

## 4. 数据流 (Data Flow)
1. 前端加载详情页 -> 异步请求网格建议接口。
2. 后端 GridService 调取缓存 K 线 -> 计算区间与参数。
3. 后端返回 JSON 数据（含区间日期坐标）。
4. 前端更新图表 Reference 层与参数卡片。

## 5. 风险提示
*   本功能仅提供基于历史数据的量化参考，不构成投资建议。
*   网格交易在单边趋势行情（尤其是单边下跌）中存在较大本金亏损风险。
