# 数据源优化规划

**创建日期**: 2026-02-16
**状态**: 待实施

## 背景

**调查发现**（2026-02-16）：
- EastMoney 接口失败率 100%
- Sina 备用接口成功率 100%（自动降级工作正常）
- 实时行情功能正常（通过 Sina 获取 1515 个 ETF）
- 历史数据获取稳定性有待提升

**核心问题**：
1. EastMoney 接口极其不稳定（反爬虫、连接中断）
2. 日志分散在多个文件（server.log 和 uvicorn.log）
3. 缺少数据源健康度监控

## 优化任务

### 阶段一：基础优化（1-2 周）

#### 1.1 日志系统优化
- [x] 统一日志输出到单一文件或结构化日志系统
- [x] 增加数据源切换的明确日志标记
- [x] 添加请求耗时统计

**优先级**: 🔴 高
**预期收益**: 提升问题排查效率 50%

#### 1.2 监控告警系统
- [x] 监控各数据源的成功率（EastMoney、Sina、THS）
- [x] 当所有数据源都失败时触发告警
- [x] 监控数据获取延迟

**优先级**: 🔴 高
**预期收益**: 及时发现服务异常

### 阶段二：稳定性提升（2-4 周）

#### 2.1 Baostock 集成（历史数据）
- [x] 新建 `baostock_service.py`
- [x] 修改 `fetch_history_raw()` 优先使用 Baostock
- [ ] 数据一致性验证（Baostock vs AkShare）
- [ ] 灰度发布（10% → 50% → 100%）

**优先级**: 🟡 中
**预期收益**: 历史数据稳定性提升 60-80%
**参考文档**: `docs/research/baostock-evaluation.md`

#### 2.2 降级策略优化
- [x] EastMoney 失败后立即切换 Sina（取消 60 秒等待）
- [x] 根据历史成功率动态调整数据源优先级
- [x] 增加 THS 备用的触发条件测试

**优先级**: 🟢 低
**预期收益**: 响应速度提升 30-60 秒

### 阶段三：长期优化（持续）

#### 3.1 数据源多元化
- [ ] 评估 Tushare Pro（付费，稳定性高）
- [ ] 评估 JoinQuant API
- [ ] 建立数据源健康度评分系统

**优先级**: 🟢 低
**预期收益**: 降低单一数据源依赖风险

#### 3.2 智能降级系统
- [ ] 数据源成功率统计（滑动窗口）
- [ ] 自动调整数据源优先级
- [ ] 数据源熔断机制（连续失败 N 次后暂时禁用）

**优先级**: 🟢 低
**预期收益**: 自适应优化，减少人工干预

## 实施优先级

**立即实施**（1-2 周）：
1. 日志系统优化（1.1）
2. 监控告警系统（1.2）

**近期实施**（1 个月内）：
3. Baostock 集成（2.1）

**长期规划**（持续优化）：
4. 降级策略优化（2.2）
5. 数据源多元化（3.1）
6. 智能降级系统（3.2）

## 成功指标

- ✅ 数据获取成功率 > 99%
- ✅ 平均响应时间 < 3 秒
- ✅ 问题排查时间 < 5 分钟
- ✅ 数据源故障自动恢复时间 < 1 分钟

## 相关文档

- [Baostock 评估报告](../research/baostock-evaluation.md)
- [数据源调查报告](../research/data-source-investigation.md)（本次调查）
- [AGENTS.md](../../AGENTS.md) - 开发规范

---

**备注**: 本规划基于 2026-02-16 的调查结果，实际实施时可根据情况调整优先级。
